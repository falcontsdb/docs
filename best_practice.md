# 最佳实践

海东青数据库是一种时序数据库，针对时序数据设计了高性能高压缩比的存储格式，十分适合大量的时序数据的存储与查询，这与传统 MySQL 等行存数据库有所不同。如果忽略其中差别，仍使用传统的 MySQL 的思路来使用海东青数据库，可能无法充分释放海东青数据库的优势，因此需对一些常见的使用误区予以说明。

# 适用场景

时序数据库关心的是数据随时间的变化，并不怎么关心数据彼此之间的关系，因此它天然适用于任何监控数据，因为监控数据与时间强相关。比如软件服务的实时状态、计算机系统的实时状态、环境监测的实时状态、汽车运行的实时状态等，都非常适合使用海东青数据库，这类数据的特点除了与时间强相关外，还有数据量特别大、数据越老价值越低、数据相似度很高。



这类场景业务通常不会修改数据，且不要求数据库支持ACID事务属性，这类业务非常适合选择海东青时序数据库。但倘若用户的业务会频繁修改数据且需要事务支持，那么则不适合采用海东青时序数据库。

# 时间很重要

海东青数据库是时序数据库，存储时序数据，其中数据的时间是非常重要的。数据的时间，也即数据被采集的时间，而不是数据写入数据库的时间。尽管用户写数据时若没有指定时间，数据库也会自动以系统当前时间进行填充，但这样的数据极有可能是没有意义的，也不符合用户实际期望；因为数据经过网络传输会存在时延，更有甚者，数据库所在系统的时间不一定准确，这都会导致数据库中数据所关联的时间不是数据真正被采集的时间；如果该数据是工厂流水线的实时数据，那么期望用这样时间并不准确的数据来指导流水线的优化，显然是错误的。



因此，建议数据写入数据库前都带上该数据被采集的时间。

# 区分 tag 和 field

很多时候，使用者对于一个字段究竟应该定义为 tag 还是 field 存在疑惑，但其实只要记住以下两个原则就很容易处理了：

1. field 值随时间变化而变化，与时间强相关
1. tag 与时间无关，被监测实体的 tag 是恒定不变的。

以汽车的实时状态为例，道路上某辆汽车的速度、方向、位置是实时变化的，这些指标显然应定义为 field；但汽车的品牌、型号、颜色这些是不变的，与时间无关，它是该汽车的静态属性，我们在数据库存储这些静态属性，是为了标识检索该汽车实体，将它与其他汽车实体区别开(毕竟一个 measurement 不会只记录一辆车的实时数据)。



前面定义了什么是 tag，tag 的定义决定了 tag 的取值集合是有限的，这里来讨论怎么选择 tag：

1. 人们通常用该 tag 对被测实体分类。
1. 人们通常用该 tag 对被测实体进行标识。
1. 人们很轻易判断被测实体是否属于某个 tag 值。



仍以汽车为例，将汽车的品牌(brand)作为 tag 是恰当的，品牌是汽车很自然合理的分类方式，走在街上，人们很容易就能说出任何一辆车的品牌；将汽车的车牌号作为 tag 是恰当的，车牌号为唯一标识一辆汽车。但将汽车的重量作为 tag 是不恰当的，人们无法看见一辆汽车就准确说出它的重量，也无法根据重量去对汽车分类，根据重量去找到某辆汽车。

# 不要使用string类型表达数值

当field采用string类型时，压缩率很低，占用磁盘空间相对较高。因此当字段的逻辑属性是数值时，请使用整数或者浮点数类型，而不要采用string类型来表达，而且string类型并无法支持数值类型相关的数值操作。

此外，建议field的类型都不使用字符串，因为在时序场景下，field属性通常表示指标值，指标值的类型几乎不会是也不应该是字符串类型。

# 写入数据时尽量采用batch

海东青在每次写入时都会预写WAL日志，每次预写WAL日志都会产生至少一次磁盘IO，因此海东青建议不要每次写请求只携带一条数据，而应该将多条数据batch到一个写请求进行写入，这会大幅减少磁盘IO，从而提升系统性能。

# 尽量不要SELECT *

海东青是弱Schema，随着用户的业务演化，其field通常会存在正常的增加，以及可能存在使用新的field名称，因此有些field可能已经不被使用，但field总数量却越来越多。

因此建议业务用户在代码中 SELECT 语句中显式指定需要查询的列，而非直接SELECT *，因为SELECT *会扫描数据库中measurement所存在的所有列，这可能存在资源浪费且造成性能问题。

