# 内存控制

为尽可能避免海东青数据库因为请求压力过大而 OOM，提供了内存控制机制：

* 对单个 SELECT 请求的内存消耗进行限制，当单个 SELECT 请求消耗的内存超过阈值时会打日志报告并终止该请求。
* 能根据当前系统内存负载情况限制 SELECT 请求的处理速率，并在内存负载达到阈值时终止所有执行中的 SELECT 请求。

内存控制默认是开启的，可通过 `memcontrol`段的系统变量对内存控制的参数进行调整，所有   `memcontrol` 的系统变量配置都是立即生效的，不需要重启数据库，这些系统变量详细介绍如下。



* `enabled`: 是否开启内存控制特性，默认开启
* `log-enabled`: 是否在内存负载高时打印日志，默认开启
* `report-cvs`: 配置 csv 文件路径，内存控制模块会周期性的输出内存监控数据至该 csv 文件，默认路径为空
* `period`: 内存监控周期，内存控制模块会以该周期读取内存负载情况，并根据内存负载调整 SELECT 请求的处理速率，默认为 50ms
* `limiter-cap`: SELECT 请求速率是通过令牌桶控制的，`limiter-cap` 指定了令牌桶的最大容量。
* `max-mem-limit`：系统占用内存上限，默认为系统物理内存容量的 80%，内存负载达到该上限会终止所有执行中的 SELECT 请求。
* `soft-mem-limit`：系统占用内存软上限，默认为 `max-mem-limit `的 80%，内存负载达到该上限时开始降低 SELECT 请求的处理速率。
* `read-task-mem-limit`：单个读请求允许的最大内存开销，默认为 16G，超过该限制该请求会立即终止。
* `write-task-mem-limit`：单个写请求允许的最大内存开销，默认为 1G，超过该限制该请求会立即终止。
* `slow-task-quota`: 若请求执行的时间超过该配置指定的时间，会被判定为慢请求，会打印日志予以报告。
* `task-timeout`: 请求超时时间，若请求执行时间超过该阈值会被终止。
